<!DOCTYPE html>
{% extends "index.html" %}
{% load static %}


{% block main_contents %}
<div class="container-fluid px-2 my-3">
    <div class="card" style="border: none; background-color: transparent; border-radius: 8px;">
        <div class="card-body px-3 pt-1">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0" style="color: #274C77; font-weight: 600; font-size: 3.0rem;">Products</h1>
            </div>

            <div class="container my-0 d-flex w-100" style="gap: 20px;">
                <!-- Sidebar Filter -->
                <div class="card mb-4" style="border: none; border-radius: 8px; width: 250px;">
                    <div class="card-header" style="background-color: #274C77; color: white; border-radius: 8px 8px 0 0;">
                        <h5 class="card-title mb-0"><i class="bi bi-filter"></i> Search Filters</h5>
                    </div>

                    <div class="filter-container me-3" style="width: 30vh; padding: 15px;">
                        <!-- Category -->
                        <div class="mb-3">    
                            <label for="category">Category:</label>
                            <select id="category" class="form-control" onchange="applyFilters()">
                                <option value="">All</option>
                                <option value="helmet">Helmet</option>
                                <option value="top box">Top Box</option>
                            </select>  
                        </div>
                        <!-- Price Range -->
                        <div class="mb-3">
                            <label>Price Range:</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="minPrice" placeholder="₱ MIN" class="form-control me-2" style="width: 90px;" oninput="applyFilters()">
                                <span>—</span>
                                <input type="number" id="maxPrice" placeholder="₱ MAX" class="form-control ms-2" style="width: 90px;" oninput="applyFilters()">
                            </div>
                        </div>
                        <!-- Brand -->
                        <div class="mb-3">
                            <label for="brand">Brand:</label>
                            <input type="text" id="brand" class="form-control" placeholder="Type brand" oninput="applyFilters()">
                        </div>

                        <!-- Color -->
                        <div class="mb-3">
                            <label for="color">Color:</label>
                            <input type="text" id="color" class="form-control" placeholder="Type color" oninput="applyFilters()">
                        </div>

                        <!-- Size -->
                        <div class="mb-3">
                            <label>Size:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Std" id="sizeStandard" onchange="applyFilters()">
                                <label class="form-check-label" for="sizeStandard">Standard</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="M" id="sizeM" onchange="applyFilters()">
                                <label class="form-check-label" for="sizeM">Medium</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="L" id="sizeL" onchange="applyFilters()">
                                <label class="form-check-label" for="sizeL">Large</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="XL" id="sizeXL" onchange="applyFilters()">
                                <label class="form-check-label" for="sizeXL">Extra Large</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="K" id="sizeKids" onchange="applyFilters()">
                                <label class="form-check-label" for="sizeKids">Kids</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Type:</label>  
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Half-Face" id="typeHalf" onchange="applyFilters()">
                                <label class="form-check-label" for="typeHalf">Half-Face</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="Full-Face" id="typeFull" onchange="applyFilters()">
                                <label class="form-check-label" for="typeFull">Full-Face</label>
                            </div>       
                        </div>
                        
                        <!-- Visor Type -->
                        <div class="mb-3">
                            <label>Visor Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="visorSingle" value="Single" onchange="applyFilters()">
                                <label class="form-check-label" for="visorSingle">Single</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="visorDouble" value="Double" onchange="applyFilters()">
                                <label class="form-check-label" for="visorDouble">Double</label>
                            </div>
                        </div>

                        <!-- Stocks -->
                        <div class="mb-3">
                            <label>Stocks:</label>  
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="inStock" onchange="applyFilters()">
                                <label class="form-check-label" for="inStock">In Stock</label>  
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Catalog -->
                <div class="card mb-4 flex-grow-1" style="border: none; border-radius: 8px;">
                    <div class="card-header" style="background-color: #274C77; color: white; border-radius: 8px 8px 0 0;">
                        <h5 class="card-title mb-0">Product Catalog</h5>
                    </div>
                    <div class="card-body p-0 overflow-auto">
                        <div class="product-table">
                            {% include "productTable.html" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
body {
    background: linear-gradient(to right, #d9dde4, #7196b3); /* Subtle gradient */
    height: 100%;
    overflow: hidden;
}


   #productTable {
    width: 100%;
    border-collapse: collapse;
}


.table-container thead {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
}


/* Ensure the table expands fully */
.product-table {
    width: 100%;
    overflow-x: auto;
}




/* Fix table header */
.table-container thead {
    position: sticky;
    top: 0;
    background: rgb(255, 255, 255);
    z-index: 2;
}


table td, table th {
    padding: 10px 10px;
}


.filter-container {
    background-color: #ffffff;
    border-radius: 8px;
    margin-right: 20px;
    flex: 1;
    min-width: 250px;
    max-width: 30%;
    padding: 10px;
}


.container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    overflow: auto;
}


.card.mb-4.flex-grow-1 {
    flex: 2;
    min-width: 40%;
}


.card-body {
    flex-grow: 1;
    max-height: 100vh;
    overflow-y: auto;
}


/* Responsive for smaller screens */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }


    .filter-container, .card.mb-4.flex-grow-1 {
        max-width: 100%;
    }
}


/* Style text fields */
.form-control {
    border: 1px solid #000000;
    border-radius: 6px; /* Rounded corners */
    transition: all 0.3s ease-in-out;
}


.form-control:focus {
    border-color: #000000; /* Darker blue on focus */
}


/* Style checkboxes */
.form-check-input {
    border: 2px solid #000000;
    border-radius: 4px; /* Slight rounding */
}


.form-check-input:checked {
    background-color: #274C77;
    border-color: #1B3A57;
}


.main-content {
    flex-grow: 1;
    max-height: calc(100vh - [header height]); /* Adjust header height accordingly */
    overflow-y: auto;
}


.product-catalog {
    max-height: 20vh; /* Adjust based on layout */
    overflow-y: auto;
}


.main-content > * {
    margin-bottom: 0;
    padding-bottom: 0;
}
</style>


<script>

function loadProducts() {
    fetch("/get-products/")
    .then(response => response.json())
    .then(data => {
        let tableBody = document.querySelector("#productTable tbody");
        tableBody.innerHTML = "";

        if (!data || !Array.isArray(data)) {
            console.error("❌ Invalid JSON format:", data);
            return;
        }

        data.forEach(item => {
            let row = `<tr 
                data-category="${item.category ? item.category.toLowerCase() : ''}"
                data-brand="${item.brand.toLowerCase()}"
                data-color="${item.color ? item.color.toLowerCase() : ''}"
                data-size="${item.size.toLowerCase()}"
                data-type="${item.helmet_type.toLowerCase()}"
                data-visor="${item.visor_type.toLowerCase()}"
                data-price="${item.price || 0}"
                data-in-stock="${item.quantity > 0}">
                <td>${item.brand}</td>
                <td>${item.model}</td>
                <td>${item.size}</td>
                <td>${item.color || "N/A"}</td>
                <td>${item.helmet_type}</td>
                <td>${item.visor_type}</td>
                <td>₱${item.price ? item.price.toLocaleString() : "N/A"}</td>
                <td>${item.quantity}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        applyFilters(); // Apply filters after loading products
    })
    .catch(error => console.error("❌ Error loading products:", error));
}


function applyFilters() {
    let category = document.getElementById("category").value.toLowerCase();
    let brand = document.getElementById("brand").value.toLowerCase();
    let color = document.getElementById("color").value.toLowerCase();
    let inStock = document.getElementById("inStock").checked;

    // Get selected price range
    let minPrice = document.getElementById("minPrice").value.trim();
    let maxPrice = document.getElementById("maxPrice").value.trim();
    minPrice = minPrice !== "" ? parseFloat(minPrice) : Number.NEGATIVE_INFINITY;
    maxPrice = maxPrice !== "" ? parseFloat(maxPrice) : Number.POSITIVE_INFINITY;

    // Get selected filter values
    let selectedSizes = Array.from(document.querySelectorAll("input[id^='size']:checked"))
        .map(checkbox => checkbox.value.toLowerCase());

    let selectedTypes = Array.from(document.querySelectorAll("input[id^='type']:checked"))
        .map(checkbox => checkbox.value.toLowerCase());

    let selectedVisors = Array.from(document.querySelectorAll("input[id^='visor']:checked"))
        .map(checkbox => checkbox.value.toLowerCase());

    let rows = document.querySelectorAll("#productTable tbody tr");

    rows.forEach(row => {
        let rowCategory = row.getAttribute("data-category")?.toLowerCase() || "";
        let rowBrand = row.getAttribute("data-brand")?.toLowerCase() || "";
        let rowColor = row.getAttribute("data-color")?.toLowerCase() || "";
        let rowSize = row.getAttribute("data-size")?.toLowerCase() || "";
        let rowType = row.getAttribute("data-type")?.toLowerCase() || "";
        let rowVisor = row.getAttribute("data-visor")?.toLowerCase() || "";
        let rowPrice = parseFloat(row.getAttribute("data-price")) || 0;
        let rowInStock = row.getAttribute("data-in-stock") === "true";

        console.log(`Row: Size=${rowSize}, Type=${rowType}, Visor=${rowVisor}, Price=${rowPrice}`);

        // Fix: Ensure filters do not hide valid rows
        let matchesCategory = category === "" || rowCategory.includes(category);
        let matchesBrand = brand === "" || rowBrand.includes(brand);
        let matchesColor = color === "" || rowColor.includes(color);
        let matchesSize = selectedSizes.length === 0 || selectedSizes.includes(rowSize);
        let matchesType = selectedTypes.length === 0 || selectedTypes.includes(rowType);
        let matchesVisor = selectedVisors.length === 0 || selectedVisors.includes(rowVisor);
        let matchesPrice = (minPrice <= rowPrice) && (rowPrice <= maxPrice);
        let matchesInStock = !inStock || rowInStock;

        let showRow = matchesCategory && matchesBrand && matchesColor && matchesSize && matchesType && matchesVisor && matchesPrice && matchesInStock;

        row.style.display = showRow ? "" : "none";
    });

    console.log("Filters applied:", { selectedSizes, selectedTypes, selectedVisors, minPrice, maxPrice });
}


window.onload = function() {
    loadProducts();
    setTimeout(applyFilters, 500); // Ensures filters apply after data loads
};
</script>
{% endblock %}

